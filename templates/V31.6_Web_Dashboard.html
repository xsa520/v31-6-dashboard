<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>V38 ç­–ç•¥å„€è¡¨æ¿</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #f1f1f1; margin: 20px; }
    .dark-toggle { position: fixed; top: 10px; right: 20px; }
    .clock { font-size: 16px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #666; padding: 8px; text-align: center; }
    th { background-color: #222; }
    .alert { background-color: #900; color: #fff; padding: 10px; margin-top: 20px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="dark-toggle">
    <button onclick="toggleMode()">åˆ‡æ›æ¨¡å¼</button>
  </div>
  <h1>V38 ç­–ç•¥ç³»çµ±å„€è¡¨æ¿</h1>
  <div class="clock">
    ğŸ• å°ç£æ™‚é–“ï¼š<span id="tw-time"></span> |
    ğŸ• ç´ç´„æ™‚é–“ï¼š<span id="us-time"></span>
  </div>
  <div>
    <b id="initial_asset">åˆå§‹é‡‘é¡ï¼š</b>&nbsp;&nbsp;
    <b id="final_asset">æœ€çµ‚é‡‘é¡ï¼š</b>&nbsp;&nbsp;
    <b id="total_cagr">CAGRï¼š</b>&nbsp;&nbsp;
    <b id="win_rate">å‹ç‡ï¼š</b>&nbsp;&nbsp;
    <b id="max_drawdown">æœ€å¤§å›æ’¤ï¼š</b>
  </div>
  <div id="asset_chart" style="height:350px;"></div>
  <h2>å–®è‚¡ç¸¾æ•ˆ</h2>
  <form id="ticker_form">
    <label>é¸æ“‡è‚¡ç¥¨ï¼š</label>
    <select name="ticker" id="ticker_select"></select>
    <span id="stock_cagr">è©²è‚¡CAGRï¼š</span>
  </form>
  <div id="stock_chart" style="height:300px;"></div>
  <h2>ğŸ§¾ æ­·å²äº¤æ˜“ç´€éŒ„</h2>
  <table id="trade_table">
    <tr><th>æ—¥æœŸ</th><th>æ¨™çš„</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th></tr>
  </table>
  <script>
    // é›»å­æ™‚é˜
    function updateClocks() {
      const now = new Date();
      document.getElementById("tw-time").innerText = now.toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      document.getElementById("us-time").innerText = now.toLocaleString("en-US", { timeZone: "America/New_York" });
    }
    setInterval(updateClocks, 1000);
    updateClocks();
    // æ˜æš—æ¨¡å¼
    function toggleMode() {
      const b = document.body;
      b.style.background = b.style.background === "white" ? "#121212" : "white";
      b.style.color = b.style.color === "black" ? "#f1f1f1" : "black";
    }
    // AJAX å‹•æ…‹æ›´æ–° dashboard
    let currentTicker = null;
    function updateDashboard() {
      let url = '/api/dashboard';
      if(currentTicker) url += '?ticker=' + encodeURIComponent(currentTicker);
      fetch(url)
        .then(response => response.json())
        .then(data => {
          // æ›´æ–°æŒ‡æ¨™
          document.getElementById('initial_asset').innerHTML = 'åˆå§‹é‡‘é¡ï¼š' + data.initial_asset;
          document.getElementById('final_asset').innerHTML = 'æœ€çµ‚é‡‘é¡ï¼š' + data.final_asset;
          document.getElementById('total_cagr').innerHTML = 'CAGRï¼š' + data.total_cagr;
          document.getElementById('win_rate').innerHTML = 'å‹ç‡ï¼š' + data.win_rate;
          document.getElementById('max_drawdown').innerHTML = 'æœ€å¤§å›æ’¤ï¼š' + data.max_drawdown;
          document.getElementById('stock_cagr').innerHTML = 'è©²è‚¡CAGRï¼š' + data.stock_cagr;
          // æ›´æ–°ä¸‹æ‹‰é¸å–®
          let tickerSelect = document.getElementById('ticker_select');
          let oldValue = tickerSelect.value;
          tickerSelect.innerHTML = '';
          data.tickers.forEach(t => {
            let opt = document.createElement('option');
            opt.value = t;
            opt.text = t;
            if(t === data.selected_ticker) opt.selected = true;
            tickerSelect.appendChild(opt);
          });
          currentTicker = data.selected_ticker;
          // æ›´æ–°è³‡ç”¢æ›²ç·š
          var asset_data = data.account_history;
          Plotly.react('asset_chart', [{
            x: asset_data.map(d => d.date),
            y: asset_data.map(d => d.asset),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'ç¸½è³‡ç”¢'
          }], {title: 'è³‡ç”¢æ·¨å€¼æ›²ç·š'});
          // æ›´æ–°å–®è‚¡ç¸¾æ•ˆæ›²ç·š
          var stock_data = data.stock_price;
          if(stock_data.length > 0){
            Plotly.react('stock_chart', [{
              x: stock_data.map(d => d.Date),
              y: stock_data.map(d => d.Close),
              type: 'scatter',
              mode: 'lines+markers',
              name: 'æ”¶ç›¤åƒ¹'
            }], {title: 'å–®è‚¡ç¸¾æ•ˆæ›²ç·š'});
          } else {
            Plotly.purge('stock_chart');
          }
          // æ›´æ–°äº¤æ˜“ç´€éŒ„è¡¨æ ¼
          let table = document.getElementById('trade_table');
          let rows = '<tr><th>æ—¥æœŸ</th><th>æ¨™çš„</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th></tr>';
          data.trade_records.forEach(t => {
            rows += `<tr><td>${t.date}</td><td>${t.ticker}</td><td>${t.action}</td><td>${t.price}</td><td>${t.shares}</td></tr>`;
          });
          table.innerHTML = rows;
        });
    }
    setInterval(updateDashboard, 1000);
    updateDashboard();
    // ä¸‹æ‹‰é¸å–®åˆ‡æ›
    document.getElementById('ticker_select').addEventListener('change', function(){
      currentTicker = this.value;
      updateDashboard();
    });
  </script>
</body>
</html>
from flask import Flask, render_template, request, jsonify
import pandas as pd
import numpy as np
import os

def calc_cagr(start_value, end_value, n_years):
    if start_value <= 0 or n_years <= 0:
        return 0
    return (end_value / start_value) ** (1 / n_years) - 1

app = Flask(__name__)

@app.route('/', methods=['GET'])
def dashboard():
    return render_template('V31.6_Web_Dashboard.html')

@app.route('/api/dashboard', methods=['GET'])
def api_dashboard():
    # 1. è®€å–è³‡ç”¢æ­·å²
    try:
        account_history = pd.read_csv('account_history.csv', parse_dates=['date'])
    except:
        account_history = pd.DataFrame(columns=['date', 'asset'])
    # 2. è®€å–äº¤æ˜“ç´€éŒ„
    try:
        trade_records = pd.read_csv('trade_records.csv')
    except:
        trade_records = pd.DataFrame(columns=['date', 'ticker', 'action', 'price', 'shares'])
    # 3. å–å¾—æ‰€æœ‰æœ‰äº¤æ˜“çš„è‚¡ç¥¨
    tickers = sorted(trade_records['ticker'].unique()) if not trade_records.empty else []
    # 4. ä¸‹æ‹‰é¸å–®é¸æ“‡è‚¡ç¥¨
    selected_ticker = request.args.get('ticker', tickers[0] if tickers else None)
    # 5. å–®è‚¡ç¸¾æ•ˆè³‡æ–™
    if selected_ticker:
        stock_trades = trade_records[trade_records['ticker'] == selected_ticker]
        try:
            stock_price = pd.read_csv(f'./sp500_data/{selected_ticker}.csv', parse_dates=['Date'])
            stock_price = stock_price.set_index('Date')
        except:
            stock_price = pd.DataFrame()
        if not stock_price.empty:
            start_price = stock_price['Close'].iloc[0]
            end_price = stock_price['Close'].iloc[-1]
            n_years = (stock_price.index[-1] - stock_price.index[0]).days / 365.25
            stock_cagr = calc_cagr(start_price, end_price, n_years)
        else:
            stock_cagr = 0
    else:
        stock_trades = pd.DataFrame()
        stock_price = pd.DataFrame()
        stock_cagr = 0
    if not account_history.empty:
        initial_asset = account_history['asset'].iloc[0]
        final_asset = account_history['asset'].iloc[-1]
        n_years = (account_history['date'].iloc[-1] - account_history['date'].iloc[0]).days / 365.25
        total_cagr = calc_cagr(initial_asset, final_asset, n_years)
    else:
        initial_asset = final_asset = total_cagr = 0
    if not trade_records.empty:
        win_trades = trade_records[(trade_records['action'] == 'è³£å‡º') & (trade_records['price'] > 0)]
        win_rate = f"{(win_trades['price'] > 0).mean() * 100:.1f}%"
    else:
        win_rate = "0%"
    if not account_history.empty:
        cummax = account_history['asset'].cummax()
        drawdown = (account_history['asset'] - cummax) / cummax
        max_drawdown = f"{drawdown.min() * 100:.2f}%"
    else:
        max_drawdown = "0%"
    return jsonify({
        'account_history': account_history.to_dict('records'),
        'trade_records': trade_records.to_dict('records'),
        'tickers': tickers,
        'selected_ticker': selected_ticker,
        'stock_trades': stock_trades.to_dict('records'),
        'stock_price': stock_price.reset_index().to_dict('records') if not stock_price.empty else [],
        'stock_cagr': f"{stock_cagr*100:.2f}%",
        'initial_asset': initial_asset,
        'final_asset': final_asset,
        'total_cagr': f"{total_cagr*100:.2f}%",
        'win_rate': win_rate,
        'max_drawdown': max_drawdown
    })

if __name__ == '__main__':
    app.run(debug=True)

